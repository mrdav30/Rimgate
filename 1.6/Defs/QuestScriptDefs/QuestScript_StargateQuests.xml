<?xml version="1.0" encoding="utf-8"?>
<Defs>

	<QuestScriptDef>
		<defName>Rimgate_StargateQuestScript</defName>
		<rootSelectionWeight>0</rootSelectionWeight>
		<isRootSpecial>true</isRootSpecial>
		<autoAccept>true</autoAccept>
		<defaultChallengeRating>2</defaultChallengeRating>
		<randomlySelectable>false</randomlySelectable>
		<questNameRules>
			<rulesStrings>
				<li>questName->[adj] glyph [site]</li>
				<li>questName->[adj] dwarfgate [site]</li>
				<li>questName->[adj] gate [site]</li>

				<li>adj->Forbidden</li>
				<li>adj->Shrouded</li>
				<li>adj->Hidden</li>
				<li>adj->Forgotten</li>
				<li>adj->Nameless</li>
				<li>adj->Lost</li>
				<li>adj->Abandoned</li>
				<li>adj->Remote</li>
				<li>adj->Ancient</li>
				<li>adj->Secret</li>
				<li>adj->Old</li>
				<li>adj->Dusty</li>
				<li>adj->Dangerous</li>
				<li>adj->Mysterious</li>
				<li>adj->Uncharted</li>
				<li>adj->Unexplored</li>

				<li>site->chamber</li>
				<li>site->vault</li>
				<li>site->complex</li>
				<li>site->site</li>
				<li>site->location</li>
				<li>site->point</li>
				<li>site->outpost</li>
				<li>site->base</li>
				<li>site->facility</li>
				<li>site->hollow</li>
				<li>site->lair</li>
				<li>site->compound</li>
				<li>site->crypt</li>
				<li>site->stronghold</li>
				<li>site->ruins</li>
				<li>site->station</li>
				<li>site->encampment</li>
				<li>site->installation</li>
				<li>site->structure</li>
				<li>site->edifice</li>
				<li>site->construct</li>
				<li>site->fortress</li>
				<li>site->citadel</li>
				<li>site->bastion</li>
				<li>site->temple</li>
				<li>site->sanctuary</li>
				<li>site->shrine</li>

			</rulesStrings>
		</questNameRules>

		<questDescriptionRules>
			<rulesStrings>
				<li>questDescription->A sequence of glyphs leads to a site of unusual construction.\n\nThe architecture resembles something far older than your colony, and its purpose is unclear. Vault? Temple? Prison?\n\nOne thing is certain: whatever lies beyond was meant to remain sealed.</li>
				<li>questDescription->The glyph sequence decodes to a location, but records are sparse.\n\nIt may be nothing but ruins. Or it may be the sort of “nothing” that eats expeditions whole.\n\nYour only way to know is to step through.</li>
				<li>questDescription->Glyphs reference a constructed site tied to an operational gate.\n\nThe style suggests human hands—advanced, yet familiar. Whether military forward post, research hub, or derelict supply depot, it remains uncharted territory.\n\nExploration is advised, but caution is paramount.</li>
				<li>questDescription->The glyphs describe a structure surrounding a dormant Dwarfgate.\n\nIt hums faintly with a resonance you can almost feel in your skull. Whether it is an abandoned lair, or something still stirring within, is impossible to tell from here.\n\nIt’s worth investigating, but be prepared for anything.</li>
			</rulesStrings>
		</questDescriptionRules>

		<root Class="QuestNode_Sequence">
			<nodes>

				<li Class="QuestNode_SubScript">
					<def>Util_GetDefaultRewardValueFromPoints</def>
				</li>

				<li Class="QuestNode_GetMap" />

				<li Class="QuestNode_IsSet">
					<name>asker</name>
					<elseNode Class="QuestNode_Set">
						<name>askerIsNull</name>
						<value>true</value>
					</elseNode>
				</li>

				<li Class="QuestNode_GetSiteTile">
					<storeAs>siteTile</storeAs>
					<preferCloserTiles>false</preferCloserTiles>
					<selectLandmarkChance>0.3</selectLandmarkChance>
					<allowedLandmarks>
						<li MayRequire="Ludeon.RimWorld.Odyssey">DryLake</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Wetland</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Valley</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Chasm</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Cliffs</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Hollow</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">TerraformingScar</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Dunes</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Plateau</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Basin</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">LavaLake</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">LavaCrater</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">LavaFlow</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Iceberg</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Fjord</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Cove</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Bay</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Peninsula</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">CoastalIsland</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Archipelago</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">HotSprings</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">ToxicLake</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Pond</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">LakeWithIsland</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">LakeWithIslands</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Lake</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">Oasis</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">IceDunes</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">AncientSmokeVent</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">AncientToxVent</li>
						<li MayRequire="Ludeon.RimWorld.Odyssey">AncientHeatVent</li>
					</allowedLandmarks>
				</li>

				<li Class="QuestNode_RandomNode">
					<nodes>
						<!-- Goa'uld -->
						<li Class="QuestNode_Sequence">
							<nodes>
								<li Class="Rimgate.QuestNode_GetFactionOfDef">
									<factionDef>Rimgate_GoauldBaal</factionDef>
									<storeAs>enemyFaction</storeAs>
								</li>
								<li Class="QuestNode_GetSitePartDefsByTagsAndFaction">
									<storeAs>sitePartDefs</storeAs>
									<storeFactionAs>siteFaction</storeFactionAs>
									<sitePartsTags>
										<li>
											<tag>Rimgate_StargateSiteGoauld</tag>
										</li>
										<li>
											<tag>Rimgate_SoldierGoauld</tag>
										</li>
									</sitePartsTags>
								</li>
							</nodes>
						</li>
						<!-- Mech -->
						<li Class="QuestNode_Sequence">
							<nodes>
								<li Class="Rimgate.QuestNode_GetFactionOfDef">
									<factionDef>Mechanoid</factionDef>
									<storeAs>enemyFaction</storeAs>
								</li>
								<li Class="QuestNode_GetSitePartDefsByTagsAndFaction">
									<storeAs>sitePartDefs</storeAs>
									<storeFactionAs>siteFaction</storeFactionAs>
									<sitePartsTags>
										<li>
											<tag>Rimgate_StargateSiteMech</tag>
										</li>
										<li>
											<tag>Rimgate_SoldierMech</tag>
										</li>
									</sitePartsTags>
								</li>
							</nodes>
						</li>
						<!-- Misc -->
						<li Class="QuestNode_GetSitePartDefsByTagsAndFaction">
							<storeAs>sitePartDefs</storeAs>
							<storeFactionAs>siteFaction</storeFactionAs>
							<sitePartsTags>
								<li>
									<tag>Rimgate_StargateSiteMisc</tag>
								</li>
								<li>
									<tag>KCSG_EnnemiesPresence</tag>
								</li>
							</sitePartsTags>
						</li>
						<!-- Tau'ri -->
						<li Class="QuestNode_GetSitePartDefsByTagsAndFaction">
							<storeAs>sitePartDefs</storeAs>
							<storeFactionAs>siteFaction</storeFactionAs>
							<sitePartsTags>
								<li>
									<tag>Rimgate_StargateSiteTauri</tag>
								</li>
								<li>
									<tag>Rimgate_SoldierReplicator</tag>
									<chance>0.5</chance>
								</li>
								<li>
									<tag>Rimgate_SoldierGoauld</tag>
									<chance>0.5</chance>
								</li>
								<li>
									<tag>KCSG_EnnemiesPresence</tag>
									<chance>0.5</chance>
								</li>
							</sitePartsTags>
						</li>
						<!-- Wraith -->
						<li Class="QuestNode_Sequence">
							<nodes>
								<li Class="Rimgate.QuestNode_GetFactionOfDef">
									<factionDef>Rimgate_WraithEmpire</factionDef>
									<storeAs>enemyFaction</storeAs>
								</li>
								<li Class="QuestNode_GetSitePartDefsByTagsAndFaction">
									<storeAs>sitePartDefs</storeAs>
									<storeFactionAs>siteFaction</storeFactionAs>
									<sitePartsTags>
										<li>
											<tag>Rimgate_StargateSiteWraith</tag>
										</li>
										<li>
											<tag>Rimgate_SoldierWraith</tag>
										</li>
									</sitePartsTags>
								</li>
							</nodes>
						</li>
					</nodes>
				</li>

				<li Class="QuestNode_GetDefaultSitePartsParams">
					<tile>$siteTile</tile>
					<faction>$siteFaction</faction>
					<sitePartDefs>$sitePartDefs</sitePartDefs>
					<storeSitePartsParamsAs>sitePartsParams</storeSitePartsParamsAs>
				</li>

				<li Class="QuestNode_SubScript">
					<def>Util_GenerateStargateSite</def>
					<parms>
						<hiddenSitePartsPossible>true</hiddenSitePartsPossible>
					</parms>
				</li>

				<li Class="QuestNode_SpawnWorldObjects">
					<worldObjects>$site</worldObjects>
				</li>

				<!-- Start custom detection raids once the site map generates -->
				<li Class="Rimgate.QuestNode_RaidStargateComplex" />

				<li Class="Rimgate.QuestNode_SpawnPawnsOnMap">
					<inSignal>site.MapGenerated</inSignal>
					<countRange>0~1</countRange> <!-- 0–2 by default -->
					<factionDef>Rimgate_TreasureHuntersHostile</factionDef>
					<pawnKind>Rimgate_TreasureHunter</pawnKind>
					<skipChance>0.45</skipChance>
					<spawnNearGate>true</spawnNearGate>
				</li>

				<li Class="QuestNode_WorldObjectTimeout">
					<worldObject>$site</worldObject>
					<isQuestTimeout>true</isQuestTimeout>
					<delayTicks>900000</delayTicks>
					<node Class="QuestNode_Sequence">
						<nodes>
							<li Class="QuestNode_RandomNode">
								<nodes>
									<li Class="QuestNode_Letter">
										<label>Quest expired: [resolvedQuestName]</label>
										<text>By the time you mobilized, the site had already been disturbed. Faded symbols mark the walls, and the gate stands silent. Whatever treasure or terror it once held is gone… for now.</text>
									</li>
									<li Class="QuestNode_Letter">
										<label>Quest expired: [resolvedQuestName]</label>
										<text>By the time you mobilized, others had already stripped the site bare.\n\nThe Dwarfgate is gone, the tech looted, and the opportunity lost.\n\nNext time, bring snacks and move faster.</text>
									</li>
									<li Class="QuestNode_Letter">
										<label>Quest expired: [resolvedQuestName]</label>
										<text>The site has been swept clean. Equipment gone, power drained, gate dismantled. A faint smell of ozone lingers, as if someone just closed the door. Another mystery, lost to time.</text>
									</li>
									<li Class="QuestNode_Letter">
										<label>Quest expired: [resolvedQuestName]</label>
										<text>Only echoes remained. The Dwarfgate is gone, stripped by unseen hands. The resonance lingers, leaving your crew uneasy. Some things are best left forgotten.</text>
									</li>
								</nodes>
							</li>

							<li Class="QuestNode_End">
								<outcome>Fail</outcome>
							</li>
						</nodes>
					</node>
				</li>

				<li Class="QuestNode_NoWorldObject">
					<worldObject>$site</worldObject>
					<node Class="QuestNode_End" />
				</li>

			</nodes>
		</root>
	</QuestScriptDef>

</Defs>